<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
  integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  label {
    border: 2px solid gray;
    border-radius: 3px;
    background-color: lightgray;
    padding: 2px;
    margin: 0 5px 0 0;
  }

  #name_input,
  #status,
  #pay_button {
    padding: 3px 5px;
    border: 2px solid rgb(64, 64, 64);
    border-radius: 5px;
  }

  #pay_button:hover {
    background-color: lightgray;
    border-radius: 5px;
  }

  #status {
    width: fit-content;
    font-weight: bold;
    background-color: lightgray;
  }

  #name_help {
    padding: 1px 4px;
    border: 1px solid transparent;
    border-radius: 10px;
  }

  #name_help:hover {
    border: 1px solid black;
    border-radius: 10px;
    background-color: lightgray;
  }

  #name_help_text {
    margin-left: 5px;
  }
</style>

<script>
  function show(id, visible) {
    let el = document.getElementById(id);
    if (el !== null) {
      el.hidden = !visible;
    }
  }

  function updateStatus(msg = null, valid = false) {
    // Reset status
    let status = document.getElementById("status");
    if (status === null) {
      return;
    }

    if (msg !== null) {
      status.innerText = msg;
      status.style["color"] = valid ? "green" : "#dd0000";
      status.hidden = false;
    } else if (window.location.hash === "#success") {
      updateStatus("Payment was successfully processed. A confirmation email has been sent.", true);
    } else if (window.location.hash === "#failure") {
      updateStatus("Payment failed. If you believe you made a mistake, please try again. Otherwise, contact Workshop coordinators for assisstance.", false);
    } else {
      status.hidden = true;
    }
  }

  const KEYS = ["transactionType", "transactionStatus", "name", "email", "accountHolderName", "transactionId"];

  function confirmUser() {
    // Get url params
    let params = new URLSearchParams(window.location.search);
    let vals = KEYS.reduce((d, key) => {
      d[key] = params.get(key);
      return d;
    }, {});

    // Make sure we actually have values
    if (Object.values(vals).findIndex(v => v === null) !== -1) {
      return;
    }

    show("loading", true);
    fetch("https://rt36h2xhtzgmizasygv7jfyij40ryooj.lambda-url.us-east-2.on.aws/", {
      method: "POST",
      body: JSON.stringify(vals)
    })
      .then(res => res.text())
      .then(res => {
        // Set loading to false in case the user hits the back button
        show("loading", false);
        window.location.replace(`${window.location.pathname}#${res === "1" ? "success" : "failure"}`);
      });
  }

  function pay() {
    let name = document.getElementById("name_input")?.value;

    if (name === null || name === "") {
      updateStatus("Name field is required", false);
      return;
    }

    show("loading", true);
    fetch("https://4oxktr2gh3xka7o7f7ilyojnuy0rorrp.lambda-url.us-east-2.on.aws/", {
      method: "POST",
      body: name
    })
      .then(res => res.text())
      .then(url => {
        // Set loading to false in case the user hits the back button
        show("loading", false);
        window.location.href = url;
      });
  }
</script>

<h1>Registration Fee Payment</h1>
<p id="status"></p>

<div style="display: flex;">
  <div style="text-wrap: nowrap;">
    <input id="name_input" type="text" placeholder="Name">
    <i id="name_help" class="fas fa-question" onmouseenter="show('name_help_text', true)"
      onmouseleave="show('name_help_text', false)"></i>
  </div>
  <span id="name_help_text" hidden="true">
    Your name will be used to record you as registered for the workshop once the registration fee has been paid.
  </span>
</div>

<br>

<span id="loading" hidden="true">
  <i class="fas fa-spinner fa-spin"></i>
</span>
<button id="pay_button" class="button" onclick="pay()">Proceed to QuikPAY Portal</button>

<script>
  updateStatus();
  confirmUser();
</script>