<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
  integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  label {
    border: 2px solid gray;
    border-radius: 3px;
    background-color: lightgray;
    padding: 2px;
    margin: 0 5px 0 0;
  }

  input {
    border: 2px solid gray;
    border-radius: 3px;
  }

  #status {
    padding: 2px 5px;
    width: fit-content;
    font-weight: bold;
    background-color: lightgray;
    border: 1px solid black;
    border-radius: 5px;
  }
</style>

<script>
  function loading(isLoading) {
    let load = document.getElementById("loading");
    if (load !== null) {
      load.hidden = !isLoading;
      console.log(load.hidden);
    }
  }

  function updateStatus() {
    // Reset status
    let status = document.getElementById("status");
    if (status === null) {
      return;
    }

    if (window.location.hash === "#success") {
      status.innerText = `Payment was successfully processed. A confirmation email has been sent.`;
      status.style["color"] = "green";
      status.hidden = false;
    } else if (window.location.hash === "#failure") {
      status.innerText = `Payment failed, please try again.`;
      status.style["color"] = "#dd0000";
      status.hidden = false;
    } else {
      status.hidden = true;
    }
  }

  const KEYS = ["transactionType", "transactionStatus", "email", "accountHolderName", "transactionId"];

  function confirmUser() {
    // Get url params
    let params = new URLSearchParams(window.location.search);
    let vals = KEYS.reduce((d, key) => {
      d[key] = params.get(key);
      return d;
    }, {});

    // Make sure we actually have values
    if (Object.values(vals).findIndex(v => v === null) !== -1) {
      return;
    }

    loading(true);
    fetch("https://rt36h2xhtzgmizasygv7jfyij40ryooj.lambda-url.us-east-2.on.aws/", {
      method: "POST",
      body: JSON.stringify(vals)
    })
      .then(res => res.text())
      // No need to stop loading as the page will reload
      .then(res => window.location.replace(`${window.location.pathname}#${res === "1" ? "success" : "failure"}`));
  }

  function pay() {
    loading(true);
    fetch("https://4oxktr2gh3xka7o7f7ilyojnuy0rorrp.lambda-url.us-east-2.on.aws/", {
      method: "GET"
    })
      .then(res => res.text())
      // No need to stop loading as the page is changing
      .then(url => window.location.href = url);
  }
</script>

<h1>Registration Fee Payment</h1>
<p id="status"></p>
<span id="loading">
  <i class="fas fa-spinner fa-spin"></i>
</span>
<button class="button" onclick="pay()">Proceed to QuikPAY Portal</button>

<script>
  loading(false);
  updateStatus();
  confirmUser();
</script>